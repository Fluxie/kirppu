// Generated by CoffeeScript 1.7.1
(function() {
  var CheckoutMode, ClerkLoginMode, CounterMode, CounterValidationMode, ItemFindMode, ModeSwitcher, b64_to_utf8, contentAfterPrefixRe, createRow, setClass, utf8_to_b64,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  utf8_to_b64 = function(str) {
    return window.btoa(encodeURIComponent(escape(str)));
  };

  b64_to_utf8 = function(str) {
    return unescape(decodeURIComponent(window.atob(str)));
  };

  ModeSwitcher = (function() {
    function ModeSwitcher(config) {
      this.cfg = config ? config : CheckoutConfig;
      this._currentMode = null;
      this._bindMenu();
    }

    ModeSwitcher.prototype.startDefault = function() {
      return this.switchTo(CounterValidationMode);
    };

    ModeSwitcher.prototype.switchTo = function(mode) {
      var newMode;
      if (this._currentMode != null) {
        if (!this._currentMode.onPreUnBind()) {
          throw new Error(this._currentMode.name + " refused to stop.");
        }
        this._currentMode.unbind();
        this._currentMode = null;
      }
      newMode = new mode(this.cfg);
      newMode.assignSwitcher(this);
      if (!newMode.onPreBind()) {
        return;
      }
      newMode.bind();
      this._currentMode = newMode;
    };

    ModeSwitcher.prototype.currentMode = function() {
      if (this._currentMode != null) {
        return this._currentMode.constructor.name;
      } else {
        return null;
      }
    };

    ModeSwitcher.prototype._bindMenu = function() {
      var entryPoint, entryPointName, item, itemDom, items, menu, _i, _len;
      menu = this.cfg.uiRef.modeMenu;
      items = menu.find("[data-entrypoint]");
      for (_i = 0, _len = items.length; _i < _len; _i++) {
        itemDom = items[_i];
        item = $(itemDom);
        entryPointName = item.attr("data-entrypoint");
        if (entryPointName in CheckoutMode.entryPoints) {
          entryPoint = CheckoutMode.entryPoints[entryPointName];
          (function(this_, ep) {
            return item.click(function() {
              console.log("Changing mode from menu to " + ep.name);
              return this_.switchTo(ep);
            });
          })(this, entryPoint);
        } else {
          console.warn("Entry point '" + entryPointName + "' could not be found from registered entry points. Source:");
          console.log(itemDom);
        }
      }
    };

    ModeSwitcher.prototype.setMenuEnabled = function(enabled) {
      var menu;
      menu = this.cfg.uiRef.modeMenu;
      setClass(menu, "disabled", !enabled);
      return setClass(menu.find("a:first"), "disabled", !enabled);
    };

    return ModeSwitcher;

  })();

  window.ModeSwitcher = ModeSwitcher;

  setClass = function(element, cls, enabled) {
    if (element.hasClass(cls) !== enabled) {
      if (enabled) {
        element.addClass(cls);
      } else {
        element.removeClass(cls);
      }
    }
    return element;
  };

  CheckoutMode = (function() {
    CheckoutMode.entryPoints = {};

    CheckoutMode.registerEntryPoint = function(name, mode) {
      if (name in this.entryPoints) {
        console.error("Name '" + name + "' was already registered for '" + this.entryPoints[name].name + "' while registering '" + mode.name + "'.");
        return;
      }
      this.entryPoints[name] = mode;
    };

    function CheckoutMode(config) {
      this.cfg = config ? config : CheckoutConfig;
      this.uiEnabled = {
        receipt: false
      };
      this.switcher = null;
    }

    CheckoutMode.prototype.assignSwitcher = function(switcher) {
      return this.switcher = switcher;
    };

    CheckoutMode.prototype.switchTo = function(mode) {
      if (this.switcher == null) {
        console.log("Would switch mode to " + mode);
        return;
      }
      return this.switcher.switchTo(mode);
    };

    CheckoutMode.prototype.title = function() {
      return "[unknown mode]";
    };

    CheckoutMode.prototype.subtitle = function() {
      return null;
    };

    CheckoutMode.prototype.initialMenuEnabled = null;

    CheckoutMode.prototype.onPreBind = function() {
      return true;
    };

    CheckoutMode.prototype.bind = function(form, input) {
      var subtitle;
      if (form == null) {
        form = this.cfg.uiRef.codeForm;
      }
      if (input == null) {
        input = this.cfg.uiRef.codeInput;
      }
      form.off("submit");
      form.submit((function(_this) {
        return function(event) {
          var ret, value;
          value = input.val();
          ret = _this.onFormSubmit(value);
          if (ret) {
            input.val("");
          } else {
            console.error("Input not accepted: '" + value + "', ret=" + ret + ", this=" + _this.constructor.name);
          }
          return event.preventDefault();
        };
      })(this));
      this.cfg.uiRef.stateText.text(this.title());
      subtitle = this.subtitle();
      if (subtitle != null) {
        this.cfg.uiRef.stateText.append(" ", $("<small>").text(subtitle));
      }
      if (this.initialMenuEnabled != null) {
        this.switcher.setMenuEnabled(this.initialMenuEnabled);
      }
    };

    CheckoutMode.prototype.onPreUnBind = function() {
      return true;
    };

    CheckoutMode.prototype.unbind = function() {};

    CheckoutMode.prototype.onFormSubmit = function(input) {
      return false;
    };

    return CheckoutMode;

  })();

  window.CheckoutMode = CheckoutMode;

  contentAfterPrefixRe = function(prefix) {
    return new RegExp("^" + escapeRegEx(prefix) + "(.+)$");
  };

  CounterValidationMode = (function(_super) {
    __extends(CounterValidationMode, _super);

    CounterValidationMode.COOKIE = "mCV";

    function CounterValidationMode(config) {
      CounterValidationMode.__super__.constructor.call(this, config);
      this._prefix = contentAfterPrefixRe(this.cfg.settings.counterPrefix);
    }

    CounterValidationMode.prototype.title = function() {
      return "Locked";
    };

    CounterValidationMode.prototype.subtitle = function() {
      return "Need to validate counter.";
    };

    CounterValidationMode.prototype.initialMenuEnabled = false;

    CounterValidationMode.prototype.onPreBind = function() {
      var code, data;
      code = $.cookie(this.constructor.COOKIE);
      if (code != null) {
        data = JSON.parse(b64_to_utf8(code));
        this.onResultSuccess(data);
        return false;
      }
      return CounterValidationMode.__super__.onPreBind.call(this);
    };

    CounterValidationMode.prototype.onFormSubmit = function(input) {
      var code, parsed;
      parsed = this._prefix.exec(input);
      if (parsed == null) {
        return false;
      }
      code = parsed[1];
      return Api.validateCounter(code, this);
    };

    CounterValidationMode.prototype.onResultSuccess = function(data) {
      var code, name;
      code = data["counter"];
      name = data["name"];
      this.cfg.settings.counterCode = code;
      this.cfg.settings.counterName = name;
      console.log("Validated " + code + " as " + name + ".");
      $.cookie(this.constructor.COOKIE, utf8_to_b64(JSON.stringify({
        counter: code,
        name: name
      })));
      return this.switchTo(ClerkLoginMode);
    };

    CounterValidationMode.prototype.onResultError = function(jqXHR) {
      if (jqXHR.status === 419) {
        console.log("Invalid counter code supplied.");
        return;
      }
      return true;
    };

    CounterValidationMode.clearStore = function() {
      return $.removeCookie(this.COOKIE);
    };

    return CounterValidationMode;

  })(CheckoutMode);

  ClerkLoginMode = (function(_super) {
    __extends(ClerkLoginMode, _super);

    function ClerkLoginMode(config) {
      ClerkLoginMode.__super__.constructor.call(this, config);
      this._prefix = contentAfterPrefixRe(this.cfg.settings.clerkPrefix);
    }

    ClerkLoginMode.prototype.title = function() {
      return "Locked";
    };

    ClerkLoginMode.prototype.subtitle = function() {
      return "Login...";
    };

    ClerkLoginMode.prototype.initialMenuEnabled = false;

    ClerkLoginMode.prototype.onFormSubmit = function(input) {
      var code, counter, parsed;
      parsed = this._prefix.exec(input);
      if (parsed == null) {
        return false;
      }
      code = parsed[0];
      counter = this.cfg.settings.counterCode;
      return Api.clerkLogin(code, counter, this);
    };

    ClerkLoginMode.prototype.onResultSuccess = function(data) {
      var username;
      username = data["user"];
      this.cfg.settings.clerkName = username;
      console.log("Logged in as " + username + ".");
      return this.switchTo(CounterMode);
    };

    ClerkLoginMode.prototype.onResultError = function(jqXHR) {
      if (jqXHR.status === 419) {
        console.log("Login failed: " + jqXHR.responseJSON["message"]);
        return;
      }
      return true;
    };

    return ClerkLoginMode;

  })(CheckoutMode);

  ItemFindMode = (function(_super) {
    __extends(ItemFindMode, _super);

    ItemFindMode.registerEntryPoint("reports", ItemFindMode);

    function ItemFindMode(config) {
      ItemFindMode.__super__.constructor.call(this, config);
    }

    ItemFindMode.prototype.title = function() {
      return "Find";
    };

    ItemFindMode.prototype.subtitle = function() {
      return "" + this.cfg.settings.clerkName + " @ " + this.cfg.settings.counterName;
    };

    ItemFindMode.prototype.initialMenuEnabled = true;

    ItemFindMode.prototype.onFormSubmit = function(input) {
      return Api.findItem(input, this);
    };

    ItemFindMode.prototype.onResultSuccess = function(data) {
      var row;
      row = createRow("?", data.code, data.name, data.price);
      return this.cfg.uiRef.receiptResult.append(row);
    };

    ItemFindMode.prototype.onResultError = function(jqXHR) {
      if (jqXHR.status === 404) {
        alert("No such item");
        return;
      }
      return true;
    };

    return ItemFindMode;

  })(CheckoutMode);

  createRow = function(index, code, name, price, rounded) {
    var modulo, price_str, rounded_str, rounded_value, row;
    if (price == null) {
      price = null;
    }
    if (rounded == null) {
      rounded = false;
    }
    if (price != null) {
      if (Number.isInteger(price)) {
        price_str = price.formatCents() + "€";
      } else {
        price_str = price;
        rounded = false;
      }
    } else {
      price_str = "";
      rounded = false;
    }
    if (rounded) {
      modulo = price % 5;
      if (modulo >= 3) {
        rounded_value = price + (5 - modulo);
      } else {
        rounded_value = price - modulo;
      }
      rounded_str = rounded_value.formatCents() + "€";
      price_str = "" + rounded_str + " (" + price_str + ")";
    }
    row = $("<tr>");
    row.append($("<td>").text(index), $("<td>").text(code), $("<td>").text(name), $("<td>").text(price_str));
    return row;
  };

  CounterMode = (function(_super) {
    __extends(CounterMode, _super);

    CounterMode.registerEntryPoint("counter", CounterMode);

    function CounterMode(config) {
      CounterMode.__super__.constructor.call(this, config);
      this._p_remove = contentAfterPrefixRe(this.cfg.settings.removeItemPrefix);
      this._p_pay = contentAfterPrefixRe(this.cfg.settings.payPrefix);
      this._receipt = null;
    }

    CounterMode.prototype.title = function() {
      return "Checkout";
    };

    CounterMode.prototype.subtitle = function() {
      return "" + this.cfg.settings.clerkName + " @ " + this.cfg.settings.counterName;
    };

    CounterMode.prototype.initialMenuEnabled = true;

    CounterMode.prototype.addRow = function(code, item, price, rounded) {
      var index, row;
      if (rounded == null) {
        rounded = false;
      }
      if (code != null) {
        this._receipt.rowCount++;
        index = this._receipt.rowCount;
        if ((price != null) && price < 0) {
          index = -index;
        }
      } else {
        code = "";
        index = "";
      }
      row = createRow(index, code, item, price, rounded);
      this.cfg.uiRef.receiptResult.prepend(row);
      return row;
    };

    CounterMode.prototype.onFormSubmit = function(input) {
      if (input.trim() === "") {
        return true;
      }
      if (this.tryPattern(this._p_remove, input, this.onRemoveItem)) {
        return true;
      }
      if (this.tryPattern(this._p_pay, input, this.onPayReceipt)) {
        return true;
      }
      if (input === this.cfg.settings.abortPrefix) {
        this.onAbortReceipt();
        return true;
      }
      if (this._receipt == null) {
        this._receipt = {
          rowCount: 0,
          total: 0,
          data: null
        };
        this.switcher.setMenuEnabled(false);
        Api.startReceipt({
          onResultSuccess: (function(_this) {
            return function(data) {
              _this._receipt.data = data;
              _this.cfg.uiRef.receiptResult.empty();
              return _this.onFormSubmit(input);
            };
          })(this),
          onResultError: (function(_this) {
            return function(jqHXR) {
              alert("Could not start receipt!");
              return true;
            };
          })(this)
        });
        return true;
      }
      Api.reserveItem(input, {
        onResultSuccess: (function(_this) {
          return function(data) {
            _this.addRow(data.code, data.name, data.price);
            return _this._receipt.total += data.price;
          };
        })(this),
        onResultError: (function(_this) {
          return function() {
            alert("Could not find item: " + input);
            return true;
          };
        })(this)
      });
      return true;
    };

    CounterMode.prototype.tryPattern = function(pattern, input, fn) {
      var value;
      value = pattern.exec(input);
      if (value != null) {
        fn.call(this, value[1]);
        return true;
      }
      return false;
    };

    CounterMode.prototype.onRemoveItem = function(input) {
      if (this._receipt == null) {
        return;
      }
      return Api.releaseItem(input, {
        onResultSuccess: (function(_this) {
          return function(data) {
            _this.addRow(data.code, data.name, -data.price);
            return _this._receipt.total -= data.price;
          };
        })(this),
        onResultError: (function(_this) {
          return function() {
            alert("Item not found on receipt: " + input);
            return true;
          };
        })(this)
      });
    };

    CounterMode.prototype.onPayReceipt = function(input) {
      var row, _i, _len, _ref;
      if (this._receipt == null) {
        return;
      }
      input = input - 0;
      if (input < this._receipt.total) {
        alert("Not enough given money!");
        return;
      }
      _ref = [this.addRow(null, "Subtotal", this._receipt.total, true), this.addRow(null, "Cash", input), this.addRow(null, "Return", input - this._receipt.total, true)];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        row = _ref[_i];
        row.addClass("success");
      }
      return Api.finishReceipt({
        onResultSuccess: (function(_this) {
          return function(data) {
            _this._receipt.data = data;
            console.log(_this._receipt);
            _this._receipt = null;
            return _this.switcher.setMenuEnabled(true);
          };
        })(this),
        onResultError: (function(_this) {
          return function() {
            alert("Error ending receipt!");
            return true;
          };
        })(this)
      });
    };

    CounterMode.prototype.onAbortReceipt = function() {
      if (this._receipt == null) {
        return;
      }
      this.addRow(null, "Aborted", null).addClass("danger");
      return Api.abortReceipt({
        onResultSuccess: (function(_this) {
          return function(data) {
            _this._receipt.data = data;
            console.log(_this._receipt);
            _this._receipt = null;
            return _this.switcher.setMenuEnabled(true);
          };
        })(this),
        onResultError: (function(_this) {
          return function() {
            alert("Error ending receipt!");
            return true;
          };
        })(this)
      });
    };

    CounterMode.prototype.onMenuItemSelected = function(item) {};

    return CounterMode;

  })(CheckoutMode);

  window.CounterValidationMode = CounterValidationMode;

  window.ClerkLoginMode = ClerkLoginMode;

  window.ItemFindMode = ItemFindMode;

}).call(this);
