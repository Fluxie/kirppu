{% load compressed %}
{% load staticfiles %}
<!doctype html>
<html>
<head>
    <title>Item listing</title>
    {% compressed_css 'general' %}
    {% compressed_css 'price_tags' %}
    {% compressed_js 'general' %}
    {% compressed_js 'jeditable' %}
</head>
<body>
    <form method="POST">
        {% csrf_token %}
        <button id="add_short_item" data-vendorid="1" data-title="title" data-url="dataurl" class="item-add btn btn-mini btn-info" type="button">Add item</button>
    </form>

    <script>
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        var csrftoken = getCookie('csrftoken');
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        function bind_tag_events(tags) {
            tags.each(function(index, tag) {
                $(".item_price", tag).editable("{% url 'kirppu:item_update_price' %}", {
                    indicator : "<img src='{% static "img/roller.gif" %}'>",
                    tooltip   : "Click to edit...",
                    onblur    : "submit",
                    style     : "width: 2cm"
                });
                $(".item_name", tag).editable("{% url 'kirppu:item_update_name' %}", {
                    indicator : "<img src='{% static "img/roller.gif" %}'>",
                    tooltip   : "Click to edit...",
                    onblur    : "submit",
                    style     : "inherit"
                });
                $('.item_button_delete', tag).click(function() {
                    tag.remove();
                });
                $('.item_button_toggle', tag).click(function(){
                    $(tag).toggleClass('item_short');
                });
            });
        }

        function create_tag(name, price, vendor_id, code) {
            var tag = $(".item_template").clone();
            tag.removeClass("item_template");

            return tag;
        }

        $(document).ready(function() {

            $('#add_short_item').click(function(){
                var vendorid;
                vendorid = $(this).attr("data-vendorid");
                var tag = create_tag('foobar', '15.55', '1', 'ASDF');
                tag.addClass("item_short");

                {% comment %}
                $.post('{% url 'kirppu:json_item' %}', {vendor_id: vendorid}, function(data){
                    $('#items').prepend(tag);
                    bind_tag_events($(tag));
                });
                {% endcomment %}

                $('#items').prepend(tag);
                bind_tag_events($(tag));
            });

            bind_tag_events($('.item_container'));
        });
    </script>

    {# Output a single item_container as a template for javascript. #}
    {% include 'app_items_item.html' with tag_type="template" name="" price="0" code="X" vendor_id="" %}
    
    <div id="items">
        {# Output a template container for every item user has. #}
        {% for i in items %}
            {% include 'app_items_item.html' with name=i.name price=i.price code=i.code vendor_id=i.vendor_id %}
        {% endfor %}
    </div>
</body>
</html>
